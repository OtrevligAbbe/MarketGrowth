@using System.Net.Http.Json
@using MarketGrowth.Frontend.Shared
@inject HttpClient Http
@inject AuthState Auth

@if (!Auth.IsLoggedIn)
{
    @* Visa inget om man inte är inloggad *@
}
else
{
    <div class="mg-fav-dropdown" @onclick:stopPropagation="true">
        <button class="mg-fav-dropdown-button" @onclick="ToggleOpen">
            ⭐ @Favorites.Count
        </button>

        @if (IsOpen)
        {
            <div class="mg-fav-dropdown-menu">
                @if (IsLoading)
                {
                    <div class="mg-fav-dropdown-item">
                        Loading favourites...
                    </div>
                }
                else if (Favorites.Count == 0)
                {
                    <div class="mg-fav-dropdown-item">
                        You have no favourites yet.
                    </div>
                }
                else
                {
                    @foreach (var fav in Favorites)
                    {
                        <div class="mg-fav-dropdown-item">
                            <span>@fav.Symbol (@fav.AssetType)</span>

                            <button type="button"
                                    class="mg-fav-dropdown-remove"
                                    @onclick="() => RemoveFavoriteAsync(fav)">
                                Remove
                            </button>
                        </div>
                    }
                }
            </div>
        }
    </div>
}

@code {
    private bool IsOpen;
    private bool IsLoading;
    private List<FavoriteAssetRequest> Favorites = new();

    // vi använder inget OnChange-event – allt laddas när man öppnar dropdownen
    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    private async Task ToggleOpen()
    {
        IsOpen = !IsOpen;

        if (IsOpen && Auth.IsLoggedIn)
        {
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        if (string.IsNullOrWhiteSpace(Auth.UserId))
        {
            Favorites.Clear();
            return;
        }

        IsLoading = true;
        StateHasChanged();

#if DEBUG
        var baseUrl = "http://localhost:7247";
#else
        var baseUrl = "https://marketgrowth-api-astenhoff-ajhuarfah0akf5gp.swedencentral-01.azurewebsites.net";
#endif

        var url = $"{baseUrl}/api/favorites/{Auth.UserId}";

        try
        {
            Favorites = await Http.GetFromJsonAsync<List<FavoriteAssetRequest>>(url)
                        ?? new List<FavoriteAssetRequest>();
        }
        catch
        {
            // om API:t dör → visa bara tom lista
            Favorites.Clear();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RemoveFavoriteAsync(FavoriteAssetRequest fav)
    {
        if (string.IsNullOrWhiteSpace(Auth.UserId))
            return;

#if DEBUG
        var baseUrl = "http://localhost:7247";
#else
        var baseUrl = "https://marketgrowth-api-astenhoff-ajhuarfah0akf5gp.swedencentral-01.azurewebsites.net";
#endif

        var deleteUrl = $"{baseUrl}/api/favorites/{Auth.UserId}/{fav.Symbol}";

        try
        {
            await Http.DeleteAsync(deleteUrl);
            Favorites.Remove(fav);
        }
        catch
        {
            // ignore fel
        }

        StateHasChanged();
    }
}
