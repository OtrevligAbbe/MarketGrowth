@using System.Globalization
@using MarketGrowth.Frontend.Shared
@inject AuthState Auth
@inject HttpClient Http
@implements IDisposable

<div class="mg-fav-wrapper" @onclick:stopPropagation="true">
    <button type="button"
            class="mg-fav-pill"
            @onclick="ToggleOpen">
        <span class="mg-fav-pill-icon">★</span>
        <span class="mg-fav-pill-count">@Auth.FavoritesCount</span>
    </button>

    @if (IsOpen)
    {
        <div class="mg-fav-dropdown">
            @if (!Auth.IsLoggedIn)
            {
                <div class="mg-fav-empty">
                    Log in to save favourites.
                </div>
            }
            else if (Auth.FavoritesCount == 0)
            {
                <div class="mg-fav-empty">
                    You have no favourites yet.
                </div>
            }
            else
            {
                @foreach (var fav in Auth.Favorites)
                {
                    <div class="mg-fav-item">
                        <div class="mg-fav-item-main">
                            <span class="mg-fav-symbol">@fav.Symbol</span>
                            <span class="mg-fav-type">@fav.AssetType</span>
                        </div>

                        <div class="mg-fav-item-right">
                            <span class="mg-fav-price">
                                @fav.LastPrice.ToString(
                                    "C2",
                                    CultureInfo.GetCultureInfo("en-US"))
                            </span>

                            <button type="button"
                                    class="mg-fav-remove-btn"
                                    @onclick="() => RemoveFavoriteAsync(fav)">
                                Remove
                            </button>
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private bool IsOpen;

    protected override async Task OnInitializedAsync()
    {
        Auth.OnChange += HandleAuthChanged;

        if (Auth.IsLoggedIn && !string.IsNullOrWhiteSpace(Auth.UserId))
        {
            await Auth.ReloadFavoritesAsync();
        }
    }

    private void ToggleOpen()
    {
        IsOpen = !IsOpen;
    }

    private void HandleAuthChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task RemoveFavoriteAsync(FavoriteAssetRequest fav)
    {
        if (!Auth.IsLoggedIn || string.IsNullOrWhiteSpace(Auth.UserId))
            return;

#if DEBUG
        var baseUrl = "http://localhost:7247";
#else
        var baseUrl = "https://marketgrowth-api-astenhoff-ajhuarfah0akf5gp.swedencentral-01.azurewebsites.net";
#endif

        var url = $"{baseUrl}/api/favorites/{Auth.UserId}/{fav.Symbol}";

        try
        {
            await Http.DeleteAsync(url);

            await Auth.ReloadFavoritesAsync();
        }
        catch
        {
        }
    }

    public void Dispose()
    {
        Auth.OnChange -= HandleAuthChanged;
    }
}
