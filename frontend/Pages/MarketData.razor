@page "/marketdata"
@using System.Net.Http.Json

@inject HttpClient Http

<PageTitle>MarketGrowth - Crypto Overview</PageTitle>

<div class="container mt-4">

    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold">MarketGrowth</h1>
            <p class="text-muted mb-0">Live crypto overview - powered by Azure Functions</p>
        </div>

        <div class="text-end mt-3 mt-md-0">
            <div class="small text-muted">Last updated</div>
            <div class="fw-semibold">
                @_timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </div>

            @if (_data != null)
            {
                <div class="small text-success mt-1">
                    Tracking @_data.Count assets
                </div>
            }
        </div>
    </div>

    <!-- LOADING -->
    @if (_isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <!-- ERROR -->
        <div class="alert alert-danger">
            <h5>Failed to load market data</h5>
            <p>@_errorMessage</p>
        </div>
    }
    else if (_data != null)
    {
        <!-- TABLE -->
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Asset</th>
                        <th class="text-end">Price (USD)</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>

                <tbody>
                    @{
                        int index = 1;
                    }

                    @foreach (var item in _data)
                    {
                        <tr>
                            <td class="text-muted">@index</td>

                            <td>
                                <span class="fw-semibold text-uppercase">
                                    @item.Key
                                </span>
                            </td>

                            <td class="text-end fw-bold">
                                $@item.Value.Usd.ToString("N2")
                            </td>

                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-warning"
                                        @onclick="(() => SaveFavorite(item.Key))">
                                    ⭐ Favorite
                                </button>
                            </td>
                        </tr>

                        index++;
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {

    private Dictionary<string, CoinData>? _data;
    private DateTime _timestamp;
    private string? _errorMessage;
    private bool _isLoading = true;

    public class CoinData
    {
        public decimal Usd { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            _data = await Http.GetFromJsonAsync<Dictionary<string, CoinData>>(
                "api/market/crypto"
            );

            _timestamp = DateTime.Now;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SaveFavorite(string assetName)
    {
        // Här kopplar du senare till din Azure Function som sparar i Cosmos DB
        Console.WriteLine($"Saved favorite: {assetName}");
    }
}
