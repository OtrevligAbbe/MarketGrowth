@page "/marketdata"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>MarketGrowth - Market Overview</PageTitle>

<div class="bg-dark text-light py-4 mb-4 shadow-sm">
    <div class="container">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div>
                <h1 class="h3 mb-1">MarketGrowth - Crypto overview</h1>
                <p class="mb-0 text-muted">
                    Live prices fetched via Azure Functions &amp; external APIs.
                </p>
            </div>

            <div class="text-md-end">
                <div class="small text-muted">Last updated</div>
                <div class="fw-semibold">
                    @_timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                </div>
                @if (_data != null)
                {
                    <div class="small text-success">
                        Tracking @_data.Count assets
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="container">

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger shadow-sm">
            <h4 class="alert-heading">Could not retrieve data</h4>
            <p>@_errorMessage</p>
            <hr />
            <p class="mb-0">
                Please ensure your Azure Function is deployed and reachable at
                <code>/api/market/crypto</code>.
            </p>
        </div>
    }
    else if (_data != null)
    {
        <!-- Top cards (lite CoinGecko-känsla) -->
        <div class="row g-3 mb-4">
            @foreach (var (key, value) in _data.Take(4))
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold">@key</div>
                                    <div class="text-muted small">Crypto asset</div>
                                </div>
                                <span class="badge bg-success-subtle text-success border border-success-subtle">
                                    Live
                                </span>
                            </div>

                            <div class="mt-3">
                                <div class="text-muted small">Price</div>
                                <div class="h5 mb-0">
                                    $@value.Usd.ToString("N2")
                                </div>
                            </div>

                            <button class="btn btn-warning btn-sm mt-3 w-100"
                                    @onclick="(() => SaveFavorite(key))">
                                ⭐ Save as favorite
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Main table -->
        <div class="card border-0 shadow-sm mb-5">
            <div class="card-header bg-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                    <h2 class="h5 mb-0">All tracked assets</h2>
                    <div class="text-muted small">
                        Prices in USD - powered by CoinGecko (via Azure Functions)
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%;">Asset</th>
                            <th style="width: 30%;">Price (USD)</th>
                            <th style="width: 30%;" class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (key, value) in _data)
                        {
                            <tr>
                                <td>
                                    <div class="fw-semibold">@key</div>
                                    <div class="text-muted small">Crypto</div>
                                </td>
                                <td>
                                    <span class="fw-semibold">
                                        $@value.Usd.ToString("N2")
                                    </span>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-outline-warning btn-sm"
                                            @onclick="(() => SaveFavorite(key))">
                                        ⭐ Save as favorite
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <p>No data available.</p>
    }

</div>

@code {
    private Dictionary<string, CoinData>? _data;
    private DateTime _timestamp = DateTime.UtcNow;
    private string? _errorMessage;
    private bool _isLoading = true;

    public class CoinData
    {
        public decimal Usd { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;

        try
        {
            // Enkel HttpClient för Blazor WASM – /api proxas via Azure Static Web Apps
            _data = await Http.GetFromJsonAsync<Dictionary<string, CoinData>>("api/market/crypto");
            _timestamp = DateTime.UtcNow;
        }
        catch (AccessTokenNotAvailableException exception)
        {
            // Om du kopplar på B2C i frontend kan du fortfarande använda detta.
            exception.Redirect();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Could not call API: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SaveFavorite(string assetName)
    {
        // TODO: Anropa din SaveFavorite Azure Function här, t.ex. via Http.PostAsJsonAsync
        // och skicka med användar-id + assetName + ev. pris.

        // För nu kan vi bara logga / ev. visa toast i framtiden.
        Console.WriteLine($"Saving favorite: {assetName}");
    }
}
